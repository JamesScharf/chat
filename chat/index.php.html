<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Chat</title>
	<style>
		#messageArea {
		border-radius: 25px;
		background: #8AC007;
		padding: 20px; 
		width: 450px;
		height: 500px;    
		}
	</style>


    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
	 <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
  <div id="messageArea">
    <form action="index.php" method="post">
		<input type="text" name='usernameBox' placeholder="Username">
		<input type="password" name='Password' placeholder="Password">
		<button type="Submit">Login</button>
     </form>
	<iframe id="chatiframe" src="chatiframe.php" width="400" height="400"></iframe>
	<form action="index.php" method="post">
		<input type="text" name='messageBox' placeholder="Enter your message">
		<button type="Submit">Send</button> </br></br> 
	</form>
	
		<?php
				include('dbforchat.php');
				/*
			The next function came from https://css-tricks.com/snippets/php/detect-location-by-ip/ . I don't really understand all of it, but it returns location.
			*/
			
			setcookie('usernameCookie', "Guest", time()+60*60*24*30);
				function detect_city($ip) {  
					$default = 'UNKNOWN';

					if (!is_string($ip) || strlen($ip) < 1 || $ip == '127.0.0.1' || $ip == 'localhost')
					{
						$ip = '8.8.8.8';
						return "ON THE SERVER!";
					}

					$curlopt_useragent = 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.2) Gecko/20100115 Firefox/3.6 (.NET CLR 3.5.30729)';
					
					$url = 'http://ipinfodb.com/ip_locator.php?ip=' . urlencode($ip);
					$ch = curl_init();
					
					$curl_opt = array(
						CURLOPT_FOLLOWLOCATION  => 1,
						CURLOPT_HEADER      => 0,
						CURLOPT_RETURNTRANSFER  => 1,
						CURLOPT_USERAGENT   => $curlopt_useragent,
						CURLOPT_URL       => $url,
						CURLOPT_TIMEOUT         => 1,
						CURLOPT_REFERER         => 'http://' . $_SERVER['HTTP_HOST'],
					);
					
					curl_setopt_array($ch, $curl_opt);
					
					$content = curl_exec($ch);
					
					$curl_info = curl_getinfo($ch);
					
					if (!is_null($curl_info)) {
						$curl_info = curl_getinfo($ch);
					}
					
					curl_close($ch);
					
					$city = '';
					$state = '';
					
					if ( preg_match('{<li>City : ([^<]*)</li>}i', $content, $regs) )  {
						$city = $regs[1];
					}
					if ( preg_match('{<li>State/Province : ([^<]*)</li>}i', $content, $regs) )  {
						$state = $regs[1];
					}

					if( $city!='' && $state!='' ){
					  $location = $city . ', ' . $state;
					  return $location;
					}else{
					  return $default; 
					}
				
				}
				//END OF THE PART THAT I COPIED MOSTLY
				$results = $mysqli->query("SELECT * FROM usernames_passwords");
					if($results)
					{
						if(isset($_POST['usernameBox']) AND isset($_POST['Password'])) 
						{  
							for ($i = 0; $i < $results->num_rows; $i++)
							{
								$results->data_seek($i);
								$row = $results->fetch_assoc();
								if(($row['username'] == $_POST['usernameBox']) AND ($row['password'] == $_POST['Password']))
								{
									echo 'Validated';
									$success = true;
									$username = $row['username'];
									setcookie('usernameCookie', $username, time()+60*60*24*30);
									setcookie('isUsernameValidated', true, time()+60*60*24*15);
								}
								else{
									echo "Nope";
									$success = false;
								}
							}
							if(!$success)
							{
								echo 'Incorrect username or password.';
							}
						}
					}
					else
					{
						echo "Query failed"; 
					}
									
			
		$ip_address = $_SERVER['REMOTE_ADDR']; //Get the IP address
		$City = detect_city($ip_address);
		if(isset($_POST['messageBox'])) 
		{
			echo "Messagebox has been set";
			//if( isset( $_COOKIE['$usernameCookie'] ) && isset( $_COOKIE['$isUsernameValidated'] ))
			//{
				echo "Both issets exist";
				$usernameCookie = $_COOKIE['usernameCookie'];
				$isUsernameValidatedCookie = $_COOKIE['isUsernameValidated'];
				if($isUsernameValidatedCookie == true)
				{
					$message = $_POST['messageBox'];
					$ip_address = $_SERVER['REMOTE_ADDR']; //Get the IP address
					$results = $mysqli->query("INSERT INTO chat_record(username, message, ip_address, location) VALUES('$usernameCookie', '$message', '$ip_address', '$City')");
					header('refresh: 0');
					echo "<SCRIPT> var d = $('#div1'); d.scrollTop(d.prop('scrollHeight'));</SCRIPT>"; //Go to the bottom of the page
				}
			//}
			
		}
		
		
	?>
</div>
	
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
	<script type="text/javascript"
    src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.js"></script>

<SCRIPT>
var d = $('#chatiframe');
d.scrollTop(d.prop("scrollHeight"));</SCRIPT>

  </body>
</html>